/**
 * Created by w44 on 15-1-12.
 */

var CronJob = require('cron').CronJob;
var nodePlatAssist=require('print_assist').nodePlatAssist;
var util = require('print_util');
var db=util.mongoDBUtil;


var NodePlatSource = function () {
};

NodePlatSource.prototype.handle = function()
{
    var self = this;
    self.handleJob = new CronJob('*/5 * * * * *', function () {
        console.log("get tickets to waitQueen..................");
        self.getWaitTickets();
    });
    self.handleJob.start();
};


NodePlatSource.prototype.getWaitTickets=function(){
    var self =this;
    nodePlatAssist.sentP01(function(err,body){
        if (err) {
            //todo 看是否可尝试一次
            self.getWaitTickets();
        } else {
            //获取到订单集合
            var tickets = body.tickets;
            //直接入等待票库
            db.collection('waitTerminalTicket', {safe: true}, function (err, collection) {
                async.each(tickets, function (item) {
                    collection.insert(item, function () {
                        console.log(item.id + "已入等待终端处理库");
                    });
                }, function (err) {
                });
            });
        }
    });
};


var nodePlatSource = new NodePlatSource();

nodePlatSource.handle();

module.exports = nodePlatSource;



